name: Cherry Pick on Label

on:
  pull_request:
    types: [labeled]

permissions:
  contents: write
  pull-requests: write

jobs:
  cherry-pick:
    if: >
      github.event.pull_request.state == 'closed' &&
      github.event.pull_request.merged == true &&
      github.event.pull_request.base.ref == 'trunk' &&
      startsWith(github.event.label.name, 'CP:')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git user
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"

      - name: Get merge commit SHA for PR
        id: merge_sha
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          MERGE_SHA=$(gh pr view "$PR_NUMBER" --repo "$REPO" --json mergeCommit --jq '.mergeCommit.oid')
          if [ -z "$MERGE_SHA" ] || [ "$MERGE_SHA" == "null" ]; then
            echo "‚ùå Unable to get merge commit SHA for PR #$PR_NUMBER"
            exit 1
          fi
          echo "merge_sha=$MERGE_SHA" >> $GITHUB_OUTPUT
          echo "‚úÖ Merge commit SHA: $MERGE_SHA"

      - name: Cherry-pick to target branches
        id: cherry
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          MERGE_SHA: ${{ steps.merge_sha.outputs.merge_sha }}
          REPO: ${{ github.repository }}
          LABEL_NAME: ${{ github.event.label.name }}
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"

          SUCCESS_BRANCHES=()
          FAILED_BRANCHES=()

          # handle optional space after CP:
          if [[ "$LABEL_NAME" =~ ^CP:\ ?(.+)$ ]]; then
            target_branch="${BASH_REMATCH[1]}"
            echo "üîç Found target branch label: $target_branch"

            if git ls-remote --exit-code origin "$target_branch" >/dev/null 2>&1; then
              new_branch="feature/cherry-pick-${PR_NUMBER}-to-${target_branch//\//-}"
              echo "‚û°Ô∏è  Creating new branch: $new_branch from $target_branch"

              git fetch origin "$target_branch"
              git checkout -b "$new_branch" "origin/$target_branch"

              if git cherry-pick -x "$MERGE_SHA"; then
                echo "‚úÖ Cherry-pick successful for $target_branch"
                git push origin "$new_branch"
                SUCCESS_BRANCHES+=("$target_branch")

                gh pr create \
                  --base "$target_branch" \
                  --head "$new_branch" \
                  --title "Cherry pick #${PR_NUMBER} into ${target_branch}" \
                  --body "Automatic cherry-pick of #${PR_NUMBER} into \`${target_branch}\`."
              else
                echo "‚ö†Ô∏è Cherry-pick failed for $target_branch"
                FAILED_BRANCHES+=("$target_branch")
                git cherry-pick --abort || true
              fi
            else
              echo "üö´ Branch $target_branch not found. Skipping."
              FAILED_BRANCHES+=("$target_branch (not found)")
            fi
          fi

          {
            echo "success_branches<<EOF"
            for b in "${SUCCESS_BRANCHES[@]}"; do echo "$b"; done
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          {
            echo "failed_branches<<EOF"
            for b in "${FAILED_BRANCHES[@]}"; do echo "$b"; done
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Comment results on original PR
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          SUCCESS_BRANCHES: ${{ steps.cherry.outputs.success_branches }}
          FAILED_BRANCHES: ${{ steps.cherry.outputs.failed_branches }}
        run: |
          COMMENT="### üß© Cherry-pick Summary for #${PR_NUMBER}<br/><br/>"

          if [ -n "$SUCCESS_BRANCHES" ]; then
            COMMENT+="‚úÖ **Successful cherry-picks:**<br/>"
            while IFS= read -r branch; do
              [ -z "$branch" ] && continue
              COMMENT+="- \`${branch}\`<br/>"
            done <<< "$SUCCESS_BRANCHES"
            COMMENT+="<br/>"
          fi

          if [ -n "$FAILED_BRANCHES" ]; then
            COMMENT+="‚ö†Ô∏è **Failed or skipped cherry-picks:**<br/>"
            while IFS= read -r branch; do
              [ -z "$branch" ] && continue
              COMMENT+="- \`${branch}\`<br/>"
            done <<< "$FAILED_BRANCHES"
            COMMENT+="<br/>"
          fi

          if [ -z "$SUCCESS_BRANCHES" ] && [ -z "$FAILED_BRANCHES" ]; then
            COMMENT+="No valid cherry-pick targets found.<br/>"
          fi

          echo -e "$COMMENT"
          gh pr comment "$PR_NUMBER" --body "$COMMENT"
